<div class="container">
  <div class="header">
    <h1>Tareas por Usuario</h1>
    <div class="header-actions">
      <button class="btn-primary" (click)="toggleFormulario()">
        {{ mostrarFormulario() ? 'Cancelar' : '+ Nueva Tarea' }}
      </button>
      <button class="btn-secondary" (click)="openEditMode()">
        {{ isEditing() ? 'Cerrar editar' : 'Editar' }}
      </button>
      <button class="btn-secondary" (click)="openDeleteMode()">
        {{ isDeleting() ? 'Cerrar eliminar' : 'Eliminar' }}
      </button>
    </div>
  </div>

  <!-- Search box -->
  <div class="search-row" style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
    <input type="text" placeholder="Buscar por título" [value]="searchTerm()" (input)="onSearchInput($event)" (keyup.enter)="buscarTarea()" style="flex:1; padding:8px;" />
    <select (change)="onStateChange($event)" style="padding:8px;">
      <option value="">Todos</option>
      <option value="true">Activa</option>
      <option value="false">Inactiva</option>
    </select>
    <button class="btn-primary" (click)="buscarTarea()">Buscar</button>
    <button class="btn-secondary" (click)="clearSearch()">Limpiar</button>
  </div>

  <!-- Formulario para crear/editar/eliminar tarea -->
  @if (mostrarFormulario()) {
    <div class="form-container">
      <h2>
        @if (isDeleting()) {
          Eliminar Tarea
        } @else if (isEditing()) {
          Editar Tarea
        } @else {
          Crear Nueva Tarea
        }
      </h2>
      <form [formGroup]="tareaForm" (ngSubmit)="isDeleting() ? eliminarTarea() : crearTarea()">

        <!-- Id input is shown for both edit and delete modes -->
        @if (isEditing() || isDeleting()) {
          <div class="form-group">
            <label for="id">Id de la Tarea</label>
            <input id="id" type="number" formControlName="id" placeholder="Id de la tarea" />
          </div>
        }

        <!-- The rest of the fields are only shown when NOT deleting -->
        @if (!isDeleting()) {
          <div class="form-group">
            <label for="titulo">Título de la Tarea *</label>
            <input
              id="titulo"
              type="text"
              formControlName="titulo"
              placeholder="Título de la tarea"
              [class.error]="tareaForm.get('titulo')?.invalid && tareaForm.get('titulo')?.touched">
            @if (tareaForm.get('titulo')?.invalid && tareaForm.get('titulo')?.touched) {
              <span class="error-text">El título es requerido (mínimo 3 caracteres)</span>
            }
          </div>

          <div class="form-group">
            <label for="descripcion">Descripción</label>
            <textarea id="descripcion" formControlName="descripcion" placeholder="Descripción opcional de la tarea" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="fechaVencimiento">Fecha de Vencimiento</label>
            <input id="fechaVencimiento" type="date" formControlName="fechaVencimiento" [class.error]="tareaForm.get('fechaVencimiento')?.invalid && tareaForm.get('fechaVencimiento')?.touched">
            @if (tareaForm.get('fechaVencimiento')?.errors?.['minDate'] && tareaForm.get('fechaVencimiento')?.touched) {
              <span class="error-text">La fecha de vencimiento debe ser hoy o posterior</span>
            }
          </div>
        }

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="toggleFormulario()">Cancelar</button>

          @if (isDeleting()) {
            <button type="button" class="btn-secondary" (click)="eliminarTarea()" [disabled]="cargando()">{{ cargando() ? 'Eliminando...' : 'Eliminar' }}</button>
          } @else {
            <button type="submit" class="btn-primary" [disabled]="cargando()">{{ cargando() ? 'Creando...' : 'Crear Tarea' }}</button>
            <button type="button" class="btn-primary" (click)="editarTarea()" [disabled]="cargando()" style="margin-left:8px;">{{ cargando() ? 'Procesando...' : 'Editar Tarea' }}</button>
          }

        </div>
      </form>
    </div>
  }

  <!-- Tabla de tareas -->
  <div class="table-container">
    <!-- Error popup -->
    @if (errorMessage()) {
      <div class="overlay">
        <div class="popup">
          <h3>Error</h3>
          <p>{{ errorMessage() }}</p>
          <div class="popup-actions">
            <button class="btn-secondary" (click)="closeError()">Cerrar</button>
          </div>
        </div>
      </div>
    }
    @if (cargando() && !mostrarFormulario()) {
      <p class="loading">Cargando tareas...</p>
    } @else if (tareasUsuarios().length > 0) {
      <table>
        <thead>
          <tr>
              <th>ID</th>
            <th>Título</th>
            <th>Descripción</th>
            <th>Estado</th>
            <th>Fecha Creación</th>
            <th>Fecha Vencimiento</th>
          </tr>
        </thead>
        <tbody>
          @for (item of tareasUsuarios(); track $index) {
            <tr>
                <td>{{ item.id }}</td>
              <td>{{ item.titulo }}</td>
              <td>{{ item.descripcion || '—' }}</td>
              <td>
                <span [class.completada]="item.estado" [class.pendiente]="!item.estado">
                  {{ item.estado ? '✓ Activa' : '⏱ Inactiva' }}
                </span>
              </td>
              <td>{{ item.fechaCreacion ? (item.fechaCreacion | date: 'dd/MM/yyyy') : '—' }}</td>
              <td>{{ item.fechaVencimiento ? (item.fechaVencimiento | date: 'dd/MM/yyyy') : 'Sin fecha' }}</td>
            </tr>
          }
        </tbody>
      </table>
    } @else {
      <p class="no-data">No hay tareas para mostrar</p>
    }
  </div>
</div>

<router-outlet />
